name: å‘å¸ƒå¼€å‘å®¹å™¨DevContainer feature

on:
    push:
        tags:
            - "v*" # å½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
    workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
        inputs:
            version:
                description: 'Version tag[scala-sdkman] (e.g., 1.0.0-beta)'
                required: true

jobs:
    package-and-publish:
        # ä»…æä¾›ä»¥ä¸‹åŸç”Ÿ Runner ç¯å¢ƒ ubuntu LTS 22.04
        # win mas
        runs-on: ubuntu-latest
        permissions:
            contents:  write
            packages:  write # å…è®¸æ¨é€åŒ…åˆ° GHCR
            pull-requests: write
        
        # æ£€å‡ºä»£ç  â†’ å®‰è£… CLI â†’ æ‰“åŒ… â†’ ç™»å½• â†’ å‘å¸ƒ
        steps:
        -   name: æ£€å‡ºä»£ç åˆ°runner | Checkout Code
            uses: actions/checkout@v4
        
        # -   name: å®‰è£… Node.js | Setup Node.js
        #     uses: actions/setup-node@v4
        #     with:
        #         node-version: 20
        #         # cache: npm # npmé¡¹ç›®æ‰éœ€è¦å…¨å±€åŒ…ç¼“å­˜
        
        # -   name: å®‰è£…å¼€å‘å®¹å™¨å‘½ä»¤è¡Œ | Install DevContainer CLI
        #     run:  npm install -g @devcontainers/cli


        -   name: Override Version for Manual Release
            if: ${{ github.event_name == 'workflow_dispatch' }}
            run:  | 
                echo "åŸå§‹ç‰ˆæœ¬å·: $(jq -r '.version' ./src/scala-sdkman/devcontainer-feature.json)"
                jq ".version = \"${{ github.event.inputs.version }}\"" ./src/scala-sdkman/devcontainer-feature.json > tmp.json
                mv tmp.json ./src/scala-sdkman/devcontainer-feature.json
                echo "ä¿®æ”¹åç‰ˆæœ¬å·: $(jq -r '.version' ./src/scala-sdkman/devcontainer-feature.json)"
    

        #     # ç”Ÿæˆä¸€ä¸ªå‹ç¼©åŒ…ï¼ˆå¦‚ sdkman.tgzï¼‰ï¼ŒåŒ…å« Feature çš„æ‰€æœ‰æ–‡ä»¶å’Œå…ƒæ•°æ®
        # -   name: æ‰“åŒ…feature | Package Feature
        #     run:  |
        #      devcontainer features package ./src/scala-sdkman 
        #      ls -lh ./src/scala-sdkman  # ç¡®è®¤æ‰“åŒ…æ–‡ä»¶ç”Ÿæˆ

        # -   name: ç™»å½•GHCR |  Login to GHCR
        #     uses: docker/login-action@v3
        #     with:
        #         registry: ghcr.io
        #         username: ${{ github.actor}}
        #         password: ${{ secrets.GITHUB_TOKEN}}

        # -   name: å‘å¸ƒfeature | Publish Feature
        #     run:  |
        #      devcontainer features publish ./src/scala-sdkman \
        #      --registry ghcr.io \
        #      --namespace ${{ github.repository_owner }}/devcontainer-features

        # ä½¿ç”¨GitHub Fearued Action
        -   name:  å‘å¸ƒfeature | Publish Features
            uses:  devcontainers/action@v1
            with:  
             publish-features: "true"
             base-path-to-features: "./src"
             generate-docs: "true"
             features-namespace: "${{ github.repository_owner }}/devcontainer-features"
             oci-registry: "ghcr.io"
            env:
             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}
        -   name:  æäº¤æ–‡æ¡£ | Create PR for Documentation
            id: push_image_info
            env:
             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}
            run: |
              set -e
              echo "Start."
              # Configure git and Push updates
              git config --global user.email github-actions[bot]@users.noreply.github.com
              git config --global user.name github-actions[bot]
              git config pull.rebase false
              branch=automated-documentation-update-$GITHUB_RUN_ID
              git checkout -b $branch
              message='ğŸ“š Automated documentation update'
              # Add / update and commit
              git add src/**/README.md
              git commit -m 'Automated documentation update [skip ci]' || export NO_UPDATES=true
              # Push
              if [ "$NO_UPDATES" != "true" ] ; then
                  git push origin "$branch"
                  gh pr create \
                    --title "$message" \
                    --body "Auto-generated by CI workflow" \
                    
              fi
            
